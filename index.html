<!DOCTYPE html>
<html>
<head>
<title>Exit Trip</title>
<meta charset="utf-8" />
<script src="js/extlibs/ben0biJSLoader.js"></script>
<link rel="stylesheet" type="text/css" href="css/css.css" />
<link rel="stylesheet" type="text/css" href="js/extlibs/jdoor/jdoor.css" />
<link rel="stylesheet" type="text/css" href="js/extlibs/jdoor/themes/green.css" />
</head>
<body>
<div id="dungeon" class="cnt_overlay"></div>
<div id="values"></div>
<div id="message">Halli Hallo</div>
<div id="windows" class="cnt_overlay"></div>
<div id="buttons">
	<center>
		<a onclick="showShop();" class="rightbutton">Le Shopé</a>
	</center>
</div>
<script>
	
function print(dg,player)
{
	$("#dungeon").html(dg.print(player));
	$("#values").html(player.printValues(dg));
	if(getMessage()!="")
	{
		$("#message").html(getMessage());
		log(getMessage());
	}
}

function showShop() {log("Showshop");$('#shopwindow').jdShow();}

function main()
{
	log("MAIN");

	var window="<br /> Welcome to Exit Trip.<br /><br /><b class='item'>Blue stuff: good news</b><br />";
	window+="<b class='monster'>Red stuff: bad news</b><br />";
	window+"<b class='player'>Yellow @: your character</b><br />";
	window+="<b class='stairs'>Yellow O and V: Upwards or downwards.</b><br />";
	window+="<br />Use arrow keys to move and attack.<br />Press 'Le Shopé' button to buy stuff.<br />";
	window+="Hide windows with the X button.";
	$("#windows").jdCreateWindow("aboutwindow",100,100,300,170,"Welcome",window);

	var shop="<br />Nothing to buy yet, sorry."
	$("#windows").jdCreateWindow("shopwindow",30,30,400,300,"Le Shopé", shop);
	$('#shopwindow').hide();


	// maybe get another actual floor.
	var actualFloor=null;
	var actualFloor=getCookie("et_actualfloor");
	if(actualFloor!=null)
		actualFloor=parseInt(actualFloor)
	else
		actualFloor=0;

	// the startup properties for the dungeon.
	var props = {
		floornumber: actualFloor,
		roomcount: 15,
		mapsizex: 100,
		mapsizey: 40,
		minroomx: 3,
		minroomy: 3,
		maxroomx: 10,
		maxroomy: 10
	}
	var dg = new DungeonGenerator();
	dg.setProperties(props)
	dg.generate();

	var player = new Player();
	player.loadCookies();
	player.setPosition(dg.getPlayerStartPosition().x, dg.getPlayerStartPosition().y);
	player.move(0,dg); // show some tiles.

	print(dg, player);
	document.onkeydown = function(evt)
	{
		evt = evt || window.event;
		var charCode = evt.keyCode || evt.which;
		//log("CHAR: "+charCode);
		// get arrow keys and other special characters.
		switch(charCode)
		{
			case 37: dg=player.move(1, dg); break;
			case 38: dg=player.move(2, dg); break;
			case 39: dg=player.move(3, dg); break;
			case 40: dg=player.move(4, dg); break;
			default: break;
		}
		var charStr = String.fromCharCode(charCode);
		switch(charStr.toLowerCase())
		{
			case 'a': dg=player.move(1,dg);break;
			case 'w': dg=player.move(2,dg);break;
			case 'd': dg=player.move(3,dg);break;
			case 's': dg=player.move(4,dg);break;
		}

		// create new if died.
		if(player.getHealth()<=0)
		{
			dg.setProperties(props);
			dg.resetFloorNumber();
			dg.generate();
			dg.previousDungeon = null;
			dg.nextDungeon = null;
			player=new Player();
			player.setPosition(dg.getPlayerStartPosition().x, dg.getPlayerStartPosition().y);
			player.move(0,dg);
			setMessage("YOU DIED!<br />Welcome to your new life.");
		}
		print(dg,player)
	};
};

ben0biJSLoader.recursiveLoad("js/jsfiles.json", main);
</script>
</body>